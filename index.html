<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Live Chat</title>

<style>
:root{
--bg:#0f172a;
--panel:#111827;
--me:#2563eb;
--other:#1f2937;
--text:#e5e7eb;
--muted:#9ca3af;
}

body{
margin:0;
background:var(--bg);
font-family:system-ui;
color:var(--text);
display:flex;
justify-content:center;
}

.app{
width:100%;
max-width:420px;
height:100vh;
display:flex;
flex-direction:column;
background:var(--panel);
}

.header{
padding:12px;
background:#020617;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:600;
}

#onlineCount{
font-size:12px;
color:#22c55e;
}

#chat{
flex:1;
overflow-y:auto;
padding:12px;
display:flex;
flex-direction:column;
}

.msg{
max-width:80%;
padding:10px;
border-radius:12px;
margin-bottom:8px;
font-size:14px;
position:relative;
}

.me{
align-self:flex-end;
background:var(--me);
}

.other{
align-self:flex-start;
background:var(--other);
}

.meta{
font-size:10px;
color:var(--muted);
text-align:right;
margin-top:4px;
}

.delete{
font-size:10px;
cursor:pointer;
color:#f87171;
position:absolute;
top:4px;
right:6px;
}

.typing{
font-size:12px;
padding:5px 12px;
color:var(--muted);
}

.input{
display:flex;
gap:5px;
padding:10px;
background:#020617;
}

input{
flex:1;
padding:10px;
border:none;
border-radius:8px;
outline:none;
}

button{
padding:10px;
border:none;
border-radius:8px;
background:#2563eb;
color:white;
cursor:pointer;
}

img{
max-width:100%;
border-radius:8px;
margin-top:5px;
}
</style>
</head>
<body>

<div class="app">
<div class="header">
<span>Live Chat</span>
<div>
<span id="onlineCount">0 online</span>
<button onclick="toggleTheme()">ðŸŒ™</button>
</div>
</div>

<div id="chat"></div>
<div id="typing" class="typing"></div>

<div class="input">
<input id="msg" placeholder="Message">
<input type="file" id="imgUpload" hidden>
<button onclick="document.getElementById('imgUpload').click()">ðŸ“Ž</button>
<button onclick="send()">Send</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
getDatabase, ref, push, onChildAdded,
set, remove, onValue, update, onDisconnect
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* YOUR CONFIG */
const firebaseConfig = {
apiKey: "AIzaSyAXgubYgcfYsaeDcx8DuEFmYWJkJ6oz8so",
authDomain: "direct-chat-via-link.firebaseapp.com",
databaseURL: "https://direct-chat-via-link-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "direct-chat-via-link",
storageBucket: "direct-chat-via-link.firebasestorage.app",
messagingSenderId: "26226616717",
appId: "1:26226616717:web:89d75ac8e16d05245375c4",
measurementId: "G-HZ6RQ23289"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let username = localStorage.getItem("name") || prompt("Your name?");
localStorage.setItem("name", username);

let uid = localStorage.getItem("uid") || crypto.randomUUID();
localStorage.setItem("uid", uid);

const room = new URLSearchParams(location.search).get("room") || "default";

const chatRef = ref(db, `rooms/${room}/messages`);
const presenceRef = ref(db, `rooms/${room}/presence/${uid}`);
const typingRef = ref(db, `rooms/${room}/typing/${uid}`);
const presenceRoot = ref(db, `rooms/${room}/presence`);

set(presenceRef, true);
onDisconnect(presenceRef).remove();

/* ONLINE COUNT */
onValue(presenceRoot, snap=>{
const count = snap.exists() ? Object.keys(snap.val()).length : 0;
document.getElementById("onlineCount").innerText = count+" online";
});

/* SEND TEXT */
window.send = function(){
const text = msg.value.trim();
if(!text) return;
push(chatRef,{
text,
user:username,
uid,
time:Date.now(),
seen:false
});
msg.value="";
}

/* IMAGE UPLOAD */
imgUpload.onchange = e=>{
const file = e.target.files[0];
const reader = new FileReader();
reader.onload = ()=>{
push(chatRef,{
image:reader.result,
user:username,
uid,
time:Date.now(),
seen:false
});
};
reader.readAsDataURL(file);
};

/* TYPING */
msg.addEventListener("input",()=>{
set(typingRef,username);
setTimeout(()=>set(typingRef,null),1000);
});

onValue(ref(db,`rooms/${room}/typing`), snap=>{
let typingUsers=[];
snap.forEach(child=>{
if(child.val() && child.key!==uid) typingUsers.push(child.val());
});
document.getElementById("typing").innerText=
typingUsers.length ? typingUsers.join(", ")+" typing..." : "";
});

/* RECEIVE */
onChildAdded(chatRef, snap=>{
const m = snap.val();
const key = snap.key;

if(m.uid!==uid){
update(ref(db,`rooms/${room}/messages/${key}`),{seen:true});
}

const div = document.createElement("div");
div.className="msg "+(m.uid===uid?"me":"other");

let content = `<b>${m.user}</b><br>`;
if(m.text) content+=m.text;
if(m.image) content+=`<img src="${m.image}">`;

content+=`<div class="meta">
${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
${m.uid===uid ? (m.seen?" âœ”âœ”":" âœ”") : ""}
</div>`;

if(m.uid===uid){
content+=`<div class="delete" onclick="deleteMsg('${key}')">âœ–</div>`;
}

div.innerHTML=content;
chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
});

/* DELETE */
window.deleteMsg=function(key){
remove(ref(db,`rooms/${room}/messages/${key}`));
}

/* THEME */
window.toggleTheme=function(){
if(document.body.style.background==="white"){
location.reload();
}else{
document.body.style.background="white";
document.querySelector(".app").style.background="#f3f4f6";
document.body.style.color="black";
}
}
</script>
</body>
</html>
